<!DOCTYPE html>
<html>

  <head>
    <title>2019冠狀病毒病 - 香港慨況</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.css" integrity="sha512-XXtRBFtk/QfR8GEWwQPYjrQBHQwjidXg0wo8HJi9YOaFycWqd2uWkjJoAyx8Mb/+H8uhvmf70EAIxDnQxrwrvw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" integrity="sha512-8ou7fcyycqNuFpv9eBUT7lvFnZ/tHM7Of3qOCjxPYKBUYYuQdrbJnWH61dAez1M2p3C42GKN1m6xc/UQgfdo0w==" crossorigin="anonymous" />
    <link rel="stylesheet" href="index.css">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js" integrity="sha512-0k6FXllQktdobw8Nc8KQN2WtZrOuxpMn7jC2RKCF6LR7EdOhhrg3H5cBPxhs3CFzQVlO6ni1B9SDLUPhBs0Alg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js" integrity="sha512-EnXkkBUGl2gBm/EIZEgwWpQNavsnBbeMtjklwAa7jLj60mJk932aqzXFmdPKCG6ge/i8iOCK0Uwl1Qp+S0zowg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js" integrity="sha512-igVQ7hyQVijOUlfg3OmcTZLwYJIBXU63xL9RC12xBHNpmGJAktDnzl9Iw0J4yrSaQtDxTTVlwhY730vphoVqJQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.js" integrity="sha512-OYtVuAy6KSuCAf0HG9j12VF96ehWm00yWBkYAqwzOkGV4WLPCWlOY1q1C3Mr4ouohyL5vEPqTulTyDlT7AHoGQ==" crossorigin="anonymous"></script>
    <script src="utils.js"></script>
    <script src="models.js"></script>
    <script src="extensions.js"></script>
    <script src="charts.js"></script>
    <script>

        google.charts.load('current', {
        'packages': ['corechart']
        });

        google.charts.setOnLoadCallback(init);

        function init() {
            initExtensions()

            var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1kup0Az0xANLK1VPQ6jfXMc0DDNdxsPC7lSXg0AYOM1s/gviz/tq?gid=0&headers=1');
            query.send(handleQueryBaseResponse);

            query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1kup0Az0xANLK1VPQ6jfXMc0DDNdxsPC7lSXg0AYOM1s/gviz/tq?gid=1524525805&headers=1&range=A22:F40');
            query.send(handleQueryDistrictResponse);
        };

        function estimate(values, modelClass, start, end, last) {
            var minError = 9999;
            var minModel = null;
            var minStart = start

            for (var i = start; i < end; i++) {
                logModel = new modelClass(values, i, last);
                if (logModel.rmse < minError) {
                    minModel = logModel;
                    minError = logModel.rmse;
                    minStart = i;
                }
            }
            return {model: minModel, start: minStart};
        }

        chartControllers = []

        function handleQueryBaseResponse(response) {
            charts = [
                { factory: prepareConfirmedChart, containerId: "confirmed", sliderId: "chart_slider"},
                { factory: prepareUnlinkedRatioChart, containerId: "unlinked_ratio", sliderId: "chart_slider"},
                { factory: preparePrelimChart, containerId: "unconfirmed", sliderId: "chart_slider"},
            ];

            handleResponse(response, 
                        prepareBaseData, 
                        charts);

            var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1kup0Az0xANLK1VPQ6jfXMc0DDNdxsPC7lSXg0AYOM1s/gviz/tq?gid=1283651191&headers=1');
            query.send(handleQueryRtResponse);

            var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1kup0Az0xANLK1VPQ6jfXMc0DDNdxsPC7lSXg0AYOM1s/gviz/tq?gid=1221452521&headers=1');
            query.send(handleQueryMobilityResponse);
        }

        function handleQueryRtResponse(response) {
            handleResponse(response, 
                null, 
                { factory: prepareRtChart, data: data, containerId: "rt", sliderId: "chart_slider"});
        }

        function handleQueryDistrictResponse(response) {
            handleResponse(response, 
                null, 
                { factory: prepareDistrictChart, containerId: "district"});
        }

        function handleQueryMobilityResponse(response) {
            handleResponse(response, 
                prepareMobilityData, 
                { factory: prepareMobilityChart, containerId: "mobility", sliderId: "chart_slider"});
        }

        function handleResponse(response, dataHandler, charts) {
            if (response.isError()) {
                alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                return;
            }

            if (!!dataHandler) {
                data = dataHandler(response.getDataTable());
            } else {
                data = response.getDataTable();
            }

            if (!Array.isArray(charts)) {
                charts.data = data;
                charts = [charts];
            } else {
                for (var i = 0; i < charts.length; i++) {
                    charts[i].data = data;
                }
            }

            for (var i = 0; i < charts.length; i++) {
                var controller = ChartController.create(charts[i])
                chartControllers.push(controller);
            }
        }


        var windowResizeTimer;
        window.addEventListener('resize', function(e){
            clearTimeout(windowResizeTimer);
            windowResizeTimer = setTimeout(function(){
                for (var i = 0; i < chartControllers.length; i++) {
                    chartControllers[i].redraw();
                }
            }, 250);
        });
    </script>
  </head>

  <body>
    <div class="spacer"></div>
    <div id="chart_slider" class="slider"></div>
    <div class="container">
        <div id="confirmed" class="graph"></div>
        <div id="unlinked_ratio" class="graph"></div>
        <div id="unconfirmed" class="graph"></div>
        <div id="rt" class="graph"></div>
        <div id="mobility" class="graph"></div>
        <div id="district" class="graph"></div>
    </div>
  </body>

</html>
